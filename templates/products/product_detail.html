{% extends 'base/base.html' %}

{% block title %}Product Details - BazaarMate{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <img src="" id="product-image" class="img-fluid rounded" alt="Product Image">
        </div>
        <div class="col-md-6">
            <h1 id="product-title"></h1>
            <p class="lead" id="product-price"></p>
            <p id="product-category"></p>
            <p id="product-seller"></p>
            <p id="product-description"></p>
            
            <div class="mt-4">
                <div class="input-group mb-3" style="width: 150px;">
                    <button class="btn btn-outline-secondary" type="button" id="decrease-quantity">-</button>
                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1">
                    <button class="btn btn-outline-secondary" type="button" id="increase-quantity">+</button>
                </div>
                <button class="btn btn-primary btn-lg" id="add-to-cart">
                    <i class="bi bi-cart-plus"></i> Add to Cart
                </button>
            </div>
        </div>
    </div>
    
    <!-- Reviews Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3>Customer Reviews</h3>
            <div id="reviews-container">
                <!-- Reviews will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        
        if (productId) {
            loadProductDetails(productId);
            loadProductReviews(productId);
        }
        
        // Quantity controls
        $('#increase-quantity').click(function() {
            const quantity = parseInt($('#quantity').val());
            $('#quantity').val(quantity + 1);
        });
        
        $('#decrease-quantity').click(function() {
            const quantity = parseInt($('#quantity').val());
            if (quantity > 1) {
                $('#quantity').val(quantity - 1);
            }
        });
        
        // Add to cart
        $('#add-to-cart').click(function() {
            const productId = urlParams.get('id');
            const quantity = parseInt($('#quantity').val());
            addToCart(productId, quantity);
        });
    });
    
    function loadProductDetails(productId) {
        $.ajax({
            url: `/api/products/${productId}/`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                if (response.success) {
                    const product = response.data;
                    $('#product-image').attr('src', product.image_url || 'https://via.placeholder.com/500x500?text=Product+Image');
                    $('#product-title').text(product.title);
                    $('#product-price').html(`<strong>$${product.price}</strong>`);
                    $('#product-category').html(`<span class="badge bg-primary">${product.category_name}</span>`);
                    $('#product-seller').text(`Sold by: ${product.seller_name}`);
                    $('#product-description').text(product.description);
                }
            },
            error: function(xhr, status, error) {
                console.log('Error loading product details:', error);
                alert('Error loading product details.');
            }
        });
    }
    
    function loadProductReviews(productId) {
        $.ajax({
            url: `/api/reviews/products/${productId}/`,
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                if (response.success) {
                    displayReviews(response.data.results);
                }
            },
            error: function(xhr, status, error) {
                console.log('Error loading reviews:', error);
            }
        });
    }
    
    function displayReviews(reviews) {
        let reviewsHtml = '';
        
        if (reviews.length === 0) {
            reviewsHtml = '<p>No reviews yet. Be the first to review this product!</p>';
        } else {
            reviews.forEach(function(review) {
                reviewsHtml += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title">${review.user_name}</h5>
                            <div>
                                ${renderStars(review.rating)}
                            </div>
                        </div>
                        <p class="card-text">${review.comment || 'No comment provided.'}</p>
                        <small class="text-muted">${new Date(review.created_at).toLocaleDateString()}</small>
                    </div>
                </div>
                `;
            });
        }
        
        $('#reviews-container').html(reviewsHtml);
    }
    
    function renderStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                stars += '<i class="bi bi-star-fill text-warning"></i>';
            } else {
                stars += '<i class="bi bi-star text-warning"></i>';
            }
        }
        return stars;
    }
    
    function addToCart(productId, quantity) {
        $.ajax({
            url: '/api/cart/add/',
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: JSON.stringify({
                product_id: productId,
                quantity: quantity
            }),
            success: function(response) {
                if (response.success) {
                    alert('Product added to cart!');
                    updateCartCount();
                } else {
                    alert('Error adding product to cart: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                alert('Error adding product to cart. Please try again.');
                console.log('Error:', error);
            }
        });
    }
    
    function updateCartCount() {
        $.ajax({
            url: '/api/cart/',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                if (response.success) {
                    const itemCount = response.data.total_items;
                    $('#cart-count').text(itemCount);
                }
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}