{% extends 'base/base.html' %}

{% block title %}Shopping Cart - BazaarMate{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Your Shopping Cart</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div id="cart-items">
                <!-- Cart items will be loaded here -->
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Order Summary</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <strong id="subtotal">$0.00</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Shipping:</span>
                            <strong>$0.00</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Tax:</span>
                            <strong>$0.00</strong>
        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total:</span>
                            <strong id="total">$0.00</strong>
                        </li>
                    </ul>
                    <div class="d-grid mt-3">
                        <button class="btn btn-primary btn-lg" id="checkout-btn">Proceed to Checkout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        loadCart();
        
        $('#checkout-btn').click(function() {
            // In a real implementation, this would redirect to checkout
            alert('Checkout functionality would be implemented here.');
        });
    });
    
    function loadCart() {
        $.ajax({
            url: '/api/cart/',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                if (response.success) {
                    displayCart(response.data);
                }
            },
            error: function(xhr, status, error) {
                console.log('Error loading cart:', error);
                alert('Error loading cart. Please try again.');
            }
        });
    }
    
    function displayCart(cart) {
        let cartItemsHtml = '';
        
        if (cart.items.length === 0) {
            cartItemsHtml = `
            <div class="text-center py-5">
                <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                <h3 class="mt-3">Your cart is empty</h3>
                <p class="mb-4">Add some products to your cart</p>
                <a href="{% url 'product_list' %}" class="btn btn-primary">Continue Shopping</a>
            </div>
            `;
            $('#subtotal').text('$0.00');
            $('#total').text('$0.00');
        } else {
            cart.items.forEach(function(item) {
                cartItemsHtml += `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="${item.product.image_url || 'https://via.placeholder.com/100x100?text=Product'}" 
                                     class="img-fluid rounded" alt="${item.product.title}">
                            </div>
                            <div class="col-md-5">
                                <h5>${item.product.title}</h5>
                                <p class="mb-1"><strong>$${item.product.price}</strong></p>
                                <p class="text-muted small">Sold by: ${item.product.seller_name}</p>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group" style="width: 120px;">
                                    <button class="btn btn-outline-secondary update-quantity" 
                                            type="button" data-item-id="${item.id}" data-action="decrease">-</button>
                                    <input type="number" class="form-control text-center quantity-input" 
                                           value="${item.quantity}" data-item-id="${item.id}" min="1">
                                    <button class="btn btn-outline-secondary update-quantity" 
                                            type="button" data-item-id="${item.id}" data-action="increase">+</button>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <p class="mb-1"><strong>$${item.total_price}</strong></p>
                                <button class="btn btn-sm btn-outline-danger remove-item" data-item-id="${item.id}">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            
            $('#subtotal').text('$' + cart.total_price);
            $('#total').text('$' + cart.total_price);
        }
        
        $('#cart-items').html(cartItemsHtml);
        
        // Bind events
        $('.update-quantity').click(function() {
            const itemId = $(this).data('item-id');
            const action = $(this).data('action');
            updateQuantity(itemId, action);
        });
        
        $('.quantity-input').change(function() {
            const itemId = $(this).data('item-id');
            const quantity = $(this).val();
            updateItemQuantity(itemId, quantity);
        });
        
        $('.remove-item').click(function() {
            const itemId = $(this).data('item-id');
            removeItem(itemId);
        });
    }
    
    function updateQuantity(itemId, action) {
        const input = $(`.quantity-input[data-item-id="${itemId}"]`);
        let quantity = parseInt(input.val());
        
        if (action === 'increase') {
            quantity++;
        } else if (action === 'decrease' && quantity > 1) {
            quantity--;
        }
        
        input.val(quantity);
        updateItemQuantity(itemId, quantity);
    }
    
    function updateItemQuantity(itemId, quantity) {
        $.ajax({
            url: `/api/cart/update/${itemId}/`,
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: JSON.stringify({
                quantity: quantity
            }),
            success: function(response) {
                if (response.success) {
                    loadCart(); // Reload cart to update totals
                } else {
                    alert('Error updating item quantity: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                alert('Error updating item quantity. Please try again.');
                console.log('Error:', error);
            }
        });
    }
    
    function removeItem(itemId) {
        if (confirm('Are you sure you want to remove this item from your cart?')) {
            $.ajax({
                url: `/api/cart/remove/${itemId}/`,
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    if (response.success) {
                        loadCart(); // Reload cart
                    } else {
                        alert('Error removing item: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error removing item. Please try again.');
                    console.log('Error:', error);
                }
            });
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}