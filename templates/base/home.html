{% extends 'base/base.html' %}

{% block title %}Home - BazaarMate{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 fw-bold">Welcome to BazaarMate</h1>
        <p class="lead">Discover amazing products at unbeatable prices</p>
        <div class="search-bar mt-4">
            <form action="{% url 'product_list' %}" method="get">
                <div class="input-group">
                    <input type="text" class="form-control form-control-lg" name="q" placeholder="Search for products...">
                    <button class="btn btn-light" type="submit">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="container my-5">
    <div class="row text-center">
        <div class="col-md-4">
            <div class="feature-icon">
                <i class="bi bi-truck"></i>
            </div>
            <h5>Fast Delivery</h5>
            <p>Get your products delivered to your doorstep in no time.</p>
        </div>
        <div class="col-md-4">
            <div class="feature-icon">
                <i class="bi bi-shield-check"></i>
            </div>
            <h5>Secure Payments</h5>
            <p>Shop with confidence using our secure payment methods.</p>
        </div>
        <div class="col-md-4">
            <div class="feature-icon">
                <i class="bi bi-headset"></i>
            </div>
            <h5>24/7 Support</h5>
            <p>Our customer support team is always ready to help you.</p>
        </div>
    </div>
</div>

<!-- Featured Products -->
<div class="container my-5">
    <h2 class="text-center mb-4">Featured Products</h2>
    <div class="row" id="featured-products">
        <!-- Products will be loaded here via JavaScript -->
    </div>
    <div class="text-center mt-4">
        <a href="{% url 'product_list' %}" class="btn btn-primary">View All Products</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fetch featured products from API
    $(document).ready(function() {
        $.ajax({
            url: '/api/products/',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                if (response.success) {
                    const products = response.data.results.slice(0, 6);
                    let productHtml = '';
                    
                    products.forEach(function(product) {
                        productHtml += `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <img src="${product.image_url || 'https://via.placeholder.com/300x200?text=Product+Image'}" 
                                     class="card-img-top product-image" alt="${product.title}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${product.title}</h5>
                                    <p class="card-text flex-grow-1">${product.description.substring(0, 100)}...</p>
                                    <div class="mt-auto">
                                        <p class="card-text">
                                            <strong>$${product.price}</strong>
                                            <span class="float-end">
                                                <span class="badge bg-primary">${product.category_name}</span>
                                            </span>
                                        </p>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary add-to-cart" 
                                                    data-product-id="${product.id}">
                                                <i class="bi bi-cart-plus"></i> Add to Cart
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                    
                    $('#featured-products').html(productHtml);
                    
                    // Add to cart functionality
                    $('.add-to-cart').click(function() {
                        const productId = $(this).data('product-id');
                        addToCart(productId, 1);
                    });
                }
            },
            error: function(xhr, status, error) {
                console.log('Error fetching products:', error);
            }
        });
    });
    
    function addToCart(productId, quantity) {
        $.ajax({
            url: '/api/cart/add/',
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: JSON.stringify({
                product_id: productId,
                quantity: quantity
            }),
            success: function(response) {
                if (response.success) {
                    alert('Product added to cart!');
                    updateCartCount();
                } else {
                    alert('Error adding product to cart: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                alert('Error adding product to cart. Please try again.');
                console.log('Error:', error);
            }
        });
    }
    
    function updateCartCount() {
        $.ajax({
            url: '/api/cart/',
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(response) {
                if (response.success) {
                    const itemCount = response.data.total_items;
                    $('#cart-count').text(itemCount);
                }
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Update cart count on page load
    $(document).ready(function() {
        updateCartCount();
    });
</script>
{% endblock %}